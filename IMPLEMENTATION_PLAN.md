# План реализации FANET Backend

## Этап 1: Базовая инфраструктура (День 1) ✅ ЗАВЕРШЕН

### 1.1 Структура проекта
- [x] Создание директорий и базовых файлов
- [x] Инициализация Go модуля
- [x] Настройка зависимостей (go.mod)
- [x] Создание Makefile

### 1.2 Protobuf схемы
- [x] Определение сообщений для пилотов, термиков, станций
- [x] Схемы для API запросов/ответов
- [x] Схемы для WebSocket обновлений
- [x] Генерация Go кода (скрипт proto-gen.sh)

### 1.3 Конфигурация
- [x] Структура конфигурации (internal/config/config.go)
- [x] Загрузка из environment
- [x] Валидация параметров
- [x] Логирование (pkg/utils/logger.go)

### 1.4 Модели данных
- [x] GeoPoint и Bounds для геопространственных операций
- [x] Pilot модель с валидацией и Redis интеграцией
- [x] Thermal модель с агрегацией близких термиков
- [x] Station модель с погодными данными
- [x] Методы конвертации в/из Redis

### 1.5 Docker окружение
- [x] Multi-stage Dockerfile для оптимального размера
- [x] Docker Compose для локальной разработки
- [x] Конфигурация для Redis, MQTT, MySQL
- [x] Hot reload с Air для разработки

## Этап 2: MQTT и Redis интеграция (День 2)

### 2.1 MQTT клиент
- [ ] Подключение к брокеру
- [ ] Подписка на топики fb/b/+/f
- [ ] Обработчики сообщений
- [ ] Переподключение при сбоях

### 2.2 FANET парсер
- [ ] Парсинг заголовков пакетов
- [ ] Обработка Type 1 (Air tracking)
- [ ] Обработка Type 4 (Service/Weather)
- [ ] Обработка Type 7 (Ground tracking)
- [ ] Обработка Type 9 (Thermal)

### 2.3 Redis репозиторий
- [ ] Подключение и пулы
- [ ] Сохранение пилотов (GEOADD + HSET)
- [ ] Сохранение термиков
- [ ] Сохранение станций
- [ ] Геопространственные запросы

### 2.4 MySQL fallback
- [ ] Загрузка начальных данных при старте
- [ ] Синхронизация с Redis
- [ ] Обработка ошибок

## Этап 3: REST и WebSocket API (День 3)

### 3.1 HTTP/2 сервер
- [ ] Настройка HTTP/2
- [ ] Middleware (logging, recovery, CORS)
- [ ] Protobuf сериализация
- [ ] Компрессия ответов

### 3.2 REST endpoints
- [ ] GET /api/v1/snapshot - начальный снимок
- [ ] GET /api/v1/pilots - пилоты в регионе
- [ ] GET /api/v1/thermals - термики
- [ ] GET /api/v1/stations - метеостанции
- [ ] GET /api/v1/track/{addr} - трек пилота
- [ ] POST /api/v1/position - отправка позиции

### 3.3 WebSocket handler
- [ ] Установка соединения
- [ ] Подписка на регион
- [ ] Отправка дифференциальных обновлений
- [ ] Heartbeat и переподключение

### 3.4 Аутентификация
- [ ] Bearer token middleware
- [ ] Валидация через Laravel API
- [ ] Кэширование токенов
- [ ] Rate limiting

## Этап 4: Оптимизации (День 4)

### 4.1 Геопространственная фильтрация
- [ ] Geohash утилиты
- [ ] Эффективный поиск в радиусе
- [ ] Динамическая подписка на регионы
- [ ] Оптимизация запросов

### 4.2 Дифференциальные обновления
- [ ] Sequence numbers для сообщений
- [ ] Определение изменений
- [ ] Батчинг обновлений
- [ ] Восстановление пропущенных

### 4.3 Производительность
- [ ] Профилирование CPU/Memory
- [ ] Оптимизация горячих путей
- [ ] Connection pooling
- [ ] Benchmark тесты

### 4.4 Энергоэффективность
- [ ] HTTP/2 Server Push
- [ ] Адаптивные интервалы
- [ ] Минимизация Protobuf
- [ ] Батчинг по времени

## Этап 5: Deployment и интеграция (День 5)

### 5.1 Docker
- [ ] Multi-stage Dockerfile
- [ ] Оптимизация размера образа
- [ ] docker-compose для разработки
- [ ] Health checks

### 5.2 Kubernetes
- [ ] Deployment манифесты
- [ ] Service и Ingress
- [ ] ConfigMap и Secrets
- [ ] HPA для автомасштабирования

### 5.3 Мониторинг
- [ ] Prometheus метрики
- [ ] Grafana дашборды
- [ ] Алерты
- [ ] Трассировка

### 5.4 Интеграция с frontend
- [ ] Обновление FlightDataSync.js
- [ ] Тестирование с реальными данными
- [ ] Оптимизация на основе feedback
- [ ] Документация API

## Метрики успеха

### Производительность
- [ ] Латентность < 50ms (95 percentile)
- [ ] 10000+ concurrent WebSocket connections
- [ ] CPU usage < 50% при пиковой нагрузке
- [ ] Memory < 2GB для 10k connections

### Надежность
- [ ] Uptime 99.9%
- [ ] Автоматическое восстановление < 30 сек
- [ ] Zero message loss
- [ ] Graceful shutdown

### Энергоэффективность
- [ ] Размер сообщения < 100 bytes (Protobuf)
- [ ] Батчинг минимум 10 обновлений
- [ ] HTTP/2 multiplexing работает
- [ ] -80% батареи в полете

## Риски и митигация

1. **MQTT перегрузка**
   - Риск: Слишком много сообщений
   - Митигация: Буферизация и батчинг

2. **Redis память**
   - Риск: Out of memory при большом количестве треков
   - Митигация: TTL и ротация старых данных

3. **WebSocket масштабирование**
   - Риск: Проблемы с sticky sessions
   - Митигация: Redis Pub/Sub для координации

4. **Совместимость Protobuf**
   - Риск: Версионирование схем
   - Митигация: Backward compatibility в схемах