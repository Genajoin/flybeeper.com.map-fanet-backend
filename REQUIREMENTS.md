# Требования к системе FANET Backend

## Проблемы текущей архитектуры

1. **Производительность**: PHP/Laravel медленно, т.к. использует подключение к БД для каждого запроса
2. **Масштабируемость**: Нет фильтров по региону на карте (нужен радиус 200км от центра карты)
3. **Объем данных**: Передается полный снимок каждый раз вместо дифференциальных обновлений
4. **Протокол**: JSON вместо компактной передачи (AVRO/Protobuf)
5. **Энергопотребление**: HTTP/1.1 дорогой - множественные рукопожатия
6. **Полетные условия**: В полете повышенный расход батареи и низкая пропускная способность

## Функциональные требования

### Чтение данных
- Публичный доступ без регистрации с ограничениями
- Фильтрация по географическому региону (радиус 200км)
- Получение начального снимка при подключении
- Дальнейшее получение только изменений
- Поддержка исторических треков (последние 12 часов)

### Запись данных (лайвтрекинг)
- Требуется аутентификация через Bearer token от основного Laravel API
- Отправка собственного местоположения
- Частота обновлений адаптивная (в зависимости от скорости/активности)

### Real-time обновления
- Прямая подписка на MQTT для минимальной задержки
- WebSocket для доставки обновлений клиентам
- Автоматическая подписка на регион вокруг пользователя

## Технические требования

### Производительность
- Латентность < 50ms для региональных запросов
- Поддержка 10000+ concurrent connections
- Обработка 1000+ сообщений/сек от MQTT
- Время холодного старта < 5 секунд

### Протоколы и форматы
- HTTP/2 для эффективного мультиплексирования
- Protobuf для сериализации (вместо JSON)
- WebSocket для real-time обновлений
- MQTT для получения данных от устройств

### Энергоэффективность
- Минимизация трафика (цель: -90% от текущего)
- Батчинг обновлений (группировка за 5 секунд)
- Адаптивные интервалы обновления
- Server Push для критических данных

### Масштабируемость
- Stateless архитектура
- Горизонтальное масштабирование
- Redis Cluster поддержка
- Kubernetes-ready

### Надежность
- Graceful degradation при недоступности MQTT
- Fallback на MySQL при старте
- Автоматическое переподключение
- Health checks и метрики

## Нефункциональные требования

### Безопасность
- Bearer token валидация через Laravel API
- Rate limiting для защиты от DDoS
- Валидация входных данных
- Защита от SQL injection (хотя основное хранилище - Redis)

### Мониторинг
- Prometheus метрики
- Структурированное логирование
- Трассировка запросов
- Алерты при аномалиях

### Deployment
- Docker контейнеризация
- Kubernetes манифесты
- CI/CD ready
- Конфигурация через environment

## Целевые показатели

| Метрика | Текущее | Целевое | Улучшение |
|---------|---------|---------|-----------|
| Латентность | 800ms | 50ms | -94% |
| Размер ответа | 300KB | 30KB | -90% |
| CPU usage | 80% | 20% | -75% |
| Concurrent users | 100 | 10000 | +100x |
| Батарея (полет) | baseline | -80% | значительно |

## Технологический стек

- **Язык**: Go 1.21+ (производительность, concurrency)
- **Протокол**: HTTP/2 + Protobuf
- **Real-time**: WebSocket
- **Хранилище**: Redis (основное) + MySQL (backup)
- **Сообщения**: MQTT broker
- **Контейнеризация**: Docker
- **Оркестрация**: Kubernetes